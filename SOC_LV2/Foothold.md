# Threat Hunting: Foothold
## Inital Access
[Initial Access Tactic (TA0001)](https://attack.mitre.org/tactics/TA0001/)  
The primary objective during this phase is to gain a foothold in the network, which can be achieved through a variety of means, such as:  
- Social Engineering techniques such as phishing.
- Exploiting vulnerabilities through public-facing servers.
- Spraying credentials through exposed authentication endpoints.
- Executing commands through malicious flash drives.
- Installing cracked software with hidden malicious code.  

The common intersection of the given examples above is gaining initial access to either of the following:  
- Account access via a valid credential
- Machine access via a remote code execution  

## Execution
[Execution Tactic (TA0002)](https://attack.mitre.org/tactics/TA0002/)  
Example techniques used by adversaries are the following:  
- Execution through command-line tools like PowerShell and Windows Command Processor (cmd.exe).
- Execution through built-in system tools or using Living-off-the-land Binaries (LOLBAS).
- Execution through scripting/programming tools, such as Python or PHP.  

|Execution Technique	|Examples|
|:----|----|
|Command-line Tools| Using built-in commands through `powershell.exe` and `cmd.exe` to download and execute the staged payload.|
|Built-in System Tools	| Using `certutil.exe` or `bitsadmin.exe` for downloading the remote payload and `rundll32.exe` to run it.|
|Scripting / Programming Tools	| Using built-in functionalities of programming tools such as Python's `os.system()` or PHP's `exec()`.|  

### Hunting Execution  
- Suspicious usage of command-line tools.  
    `winlogbeat-*`  
    To hunt process creations (Sysmon Event ID 1) generated by these two tools:  
    `host.name: WKSTN-* AND winlog.event_id: 1 AND process.name: (cmd.exe OR powershell.exe)`  
    To add on PowerShell analysis, an alternative way to hunt unusual PowerShell execution is through the events generated by PowerShell's Script Block Logging.  
    ```
    host.name: WKSTN-* AND winlog.event_id: 4104
    ```  
    Some examples of PowerShell strings are provided below:  
    - invoke / invoke-expression / iex
    - -enc / -encoded
    - -noprofile / -nop
    - bypass
    - -c / -command
    - -executionpolicy / -ep
    - WebRequest
    - Download  
- Abuse of built-in system tools.  
    `winlogbeat-*`   
    To hunt process creation (Sysmon Event ID 1) as well as network connection (Sysmon Event ID 3) events:  
    ```
    host.name: WKSTN-* AND winlog.event_id: (1 OR 3) AND (process.name: (mshta.exe OR certutil.exe OR regsvr32.exe) OR process.parent.name: (mshta.exe OR certutil.exe OR regsvr32.exe))
    ```  
- Execution via programming/scripting tools.  
    `winlogbeat-*` 
    ```
    host.name: WKSTN-* AND winlog.event_id: (1 OR 3) AND (process.name: (*python* OR *php* OR *nodejs*) OR process.parent.name: (*python* OR *php* OR *nodejs*))
    ```  
    Using these findings, we can extend our investigation further by getting the process ID of the cmd.exe process spawned by Python and using it in our new KQL query.  
    Using this process PID, we can search all processes spawned by this cmd.exe instance by using it as our `process.parent.pid`:  
    ```
    host.name: WKSTN-* AND winlog.event_id: (1 OR 3) AND process.parent.pid: 1832
    ```  

## Defense Evasion
[Defense Evasion Tactic (TA0005)](https://attack.mitre.org/tactics/TA0005/)  
- Disabling security software.
- Deleting attack footprints on logs.
- Deceiving analysts through masquerading, obfuscation, and encryption. 
- Executing known bypasses to security controls.  

|Evasion Technique|Examples|
|:----|:----|
|Disabling security software|Disabling Windows Defender via the command line or reverting the updated detection signatures.|
|Deleting logs|Deleting all existing Windows Event Logs inside the compromised machine.|
|Deceiving analysts|Mimicking process names or spoofing parent process IDs.|
|Executing known bypasses|Using known vulnerabilities or modifying host configurations to bypass the controls.|  

### Hunting Defense Evasion
- Disabling security software.  
    `winlogbeat-*`  
    For this example, we will focus on known commands used to disable Windows Defender.  
    ```
    host.name: WKSTN-* AND (*DisableRealtimeMonitoring* OR *RemoveDefinitions*)
    ```  
    - DisableRealtimeMonitoring - Commonly used with PowerShell's `Set-MPPreference` to disable its real-time monitoring.
    - RemoveDefinitions - Commonly used with built-in `MpCmdRun.exe` to remove all existing signatures of Windows Defender.  
    ![3b429919f44e0d05a028d2d8f0494b66](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/e7b4f7eb-64ab-454d-b197-3aef35ca104e)  
- Log deletion attempts.  
    The simplest way to detect the deletion of Windows Event Logs is via Event ID `1102`.  
    ```
    host.name: WKSTN-* AND winlog.event_id: 1102
    ```  
    The next step of this investigation is to identify the log source that was removed and the command used to delete the logs. To complete the investigation, use `View surrounding documents` to see the command used to clear the event logs.  
    ![d3](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/b7e0696f-924a-43da-aeb8-2e1966887547)  
- Executing shellcode through process injection.  
    We will use Sysmon's capability to detect CreateRemoteThread and hunt for potential process injection. Sysmon's Event ID `8` (CreateRemoteThread), which detects when a process creates a thread in another process.  
    ```
    host.name: WKSTN-* AND winlog.event_id: 8
    ```  
    ![77c](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/411d6d22-8f11-4f97-bdb5-239b0bd01fb9)  
    








    
