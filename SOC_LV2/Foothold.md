# Threat Hunting: Foothold
# Inital Access
[Initial Access Tactic (TA0001)](https://attack.mitre.org/tactics/TA0001/)  
The primary objective during this phase is to gain a foothold in the network, which can be achieved through a variety of means, such as:  
- Social Engineering techniques such as phishing.
- Exploiting vulnerabilities through public-facing servers.
- Spraying credentials through exposed authentication endpoints.
- Executing commands through malicious flash drives.
- Installing cracked software with hidden malicious code.  

The common intersection of the given examples above is gaining initial access to either of the following:  
- Account access via a valid credential
- Machine access via a remote code execution  

## Hunting Initial Access
- Brute-forcing attempts via SSH.  
    `filebeat-*`  
    To start hunting, use the Visualize Library from the left sidebar and create a visualisation table using Lens.  
    ```
    host.name: jumphost AND event.category: authentication AND system.auth.ssh.event: Failed
    ```  
    ![a77](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/446eb925-cc47-48b0-a595-0b04d528d44d)  
    Now that we have gathered significant information about brute-force attempts, let's find a successful authentication.  
    ```
    host.name: jumphost AND event.category: authentication AND system.auth.ssh.event: Accepted AND source.ip: (167.71.198.43 OR 218.92.0.115) 
    ```  
- Exploitation of a web application vulnerability.  
    `packetbeat-*`  
    Web application attacks typically start with enumeration attempts and proceed with exploiting discovered vulnerabilities.  
    ```
    host.name: web01 AND network.protocol: http AND destination.port: 80
    ```  
    ![a81](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/b5f482b6-2112-4bd0-8f86-0926b7c7a5e5)  
    Upon checking the results above (highlight #5), it can be observed that the query provided a high count of status code `404`, indicating a directory enumeration attempt by `167.71.198.43` since the attack produces many "Page Not Found" results due to its behaviour of guessing valid endpoints.  
    ```
    host.name: web01 AND network.protocol: http AND destination.port: 80 AND source.ip: 167.71.198.43 AND http.response.status_code: 404
    ```  
    ![b3a](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/a982989a-ace4-45b9-ba2a-1317f56c4976)  
    To continue, let's replace the KQL query with status codes 200, 301, and 302 to focus on valid endpoints accessed by the attacker.  
    ```
    host.name: web01 AND network.protocol: http AND destination.port: 80 AND source.ip: 167.71.198.43 AND http.response.status_code: (200 OR 301 OR 302)
    ```  
- Phishing via links and attachments.  
    `winlogbeat-*`  
    Given this, we will hunt for the following behaviours that satisfy this idea: 
    1. Files downloaded using a web browser.
    2. Files opened from an email client (in this case, we will be hunting files opened from an Outlook client).  
    ### Files Downloaded using Chrome
    We will hunt file creations (Sysmon Event ID 11(File create)) generated by chrome.exe:  
    ```
    host.name: WKSTN-* AND process.name: chrome.exe AND winlog.event_id: 11
    ```  
    ![29](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/efae6371-22f5-4f57-9978-c70c654ba6ef)  
    Note: We can ignore the .tmp files created by Chrome. By default, chrome.exe creates a temporary file when a file is being downloaded.  
    ### Files Opened using Outlook  
    ```
    host.name: WKSTN-* AND process.name: OUTLOOK.EXE AND winlog.event_id: 11
    ```  

# Execution
[Execution Tactic (TA0002)](https://attack.mitre.org/tactics/TA0002/)  
Example techniques used by adversaries are the following:  
- Execution through command-line tools like PowerShell and Windows Command Processor (cmd.exe).
- Execution through built-in system tools or using Living-off-the-land Binaries (LOLBAS).
- Execution through scripting/programming tools, such as Python or PHP.  

|Execution Technique	|Examples|
|:----|----|
|Command-line Tools| Using built-in commands through `powershell.exe` and `cmd.exe` to download and execute the staged payload.|
|Built-in System Tools	| Using `certutil.exe` or `bitsadmin.exe` for downloading the remote payload and `rundll32.exe` to run it.|
|Scripting / Programming Tools	| Using built-in functionalities of programming tools such as Python's `os.system()` or PHP's `exec()`.|  

## Hunting Execution  
- Suspicious usage of command-line tools.  
    `winlogbeat-*`  
    To hunt process creations (Sysmon Event ID 1) generated by these two tools:  
    `host.name: WKSTN-* AND winlog.event_id: 1 AND process.name: (cmd.exe OR powershell.exe)`  
    ![63](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/b81fa472-c907-41ef-8cfc-5ae0fdbab0e4)  

    To add on PowerShell analysis, an alternative way to hunt unusual PowerShell execution is through the events generated by `PowerShell's Script Block` Logging.  
    ```
    host.name: WKSTN-* AND winlog.event_id: 4104
    ```  
    Some examples of PowerShell strings are provided below:  
    - invoke / invoke-expression / iex
    - -enc / -encoded
    - -noprofile / -nop
    - bypass
    - -c / -command
    - -executionpolicy / -ep
    - WebRequest
    - Download  
- Abuse of built-in system tools.  
    `winlogbeat-*`   
    To hunt process creation (Sysmon Event ID 1) as well as network connection (Sysmon Event ID 3) events:  
    ```
    host.name: WKSTN-* AND winlog.event_id: (1 OR 3) AND (process.name: (mshta.exe OR certutil.exe OR regsvr32.exe) OR process.parent.name: (mshta.exe OR certutil.exe OR regsvr32.exe))
    ```  
    ![33](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/42d3c16b-cbf1-4803-a3d7-ecf9e98cb286)  

- Execution via programming/scripting tools.  
    `winlogbeat-*` 
    ```
    host.name: WKSTN-* AND winlog.event_id: (1 OR 3) AND (process.name: (*python* OR *php* OR *nodejs*) OR process.parent.name: (*python* OR *php* OR *nodejs*))
    ```  
    ![6c](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/6ae9a825-2e5f-427e-a9fe-ab710cf44ec1)  

    Using these findings, we can extend our investigation further by getting the process ID of the cmd.exe process spawned by Python and using it in our new KQL query.  
    Using this process PID, we can search all processes spawned by this cmd.exe instance by using it as our `process.parent.pid`:  
    ```
    host.name: WKSTN-* AND winlog.event_id: (1 OR 3) AND process.parent.pid: 1832
    ```  

# Defense Evasion
[Defense Evasion Tactic (TA0005)](https://attack.mitre.org/tactics/TA0005/)  
- Disabling security software.
- Deleting attack footprints on logs.
- Deceiving analysts through masquerading, obfuscation, and encryption. 
- Executing known bypasses to security controls.  

|Evasion Technique|Examples|
|:----|:----|
|Disabling security software|Disabling Windows Defender via the command line or reverting the updated detection signatures.|
|Deleting logs|Deleting all existing Windows Event Logs inside the compromised machine.|
|Deceiving analysts|Mimicking process names or spoofing parent process IDs.|
|Executing known bypasses|Using known vulnerabilities or modifying host configurations to bypass the controls.|  

## Hunting Defense Evasion
- Disabling security software.  
    `winlogbeat-*`  
    For this example, we will focus on known commands used to disable Windows Defender.  
    ```
    host.name: WKSTN-* AND (*DisableRealtimeMonitoring* OR *RemoveDefinitions*)
    ```  
    - DisableRealtimeMonitoring - Commonly used with PowerShell's `Set-MPPreference` to disable its real-time monitoring.
    - RemoveDefinitions - Commonly used with built-in `MpCmdRun.exe` to remove all existing signatures of Windows Defender.  
    ![3b429919f44e0d05a028d2d8f0494b66](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/e7b4f7eb-64ab-454d-b197-3aef35ca104e)  
- Log deletion attempts.  
    The simplest way to detect the deletion of Windows Event Logs is via Event ID `1102`.  
    ```
    host.name: WKSTN-* AND winlog.event_id: 1102
    ```  
    The next step of this investigation is to identify the log source that was removed and the command used to delete the logs. To complete the investigation, use `View surrounding documents` to see the command used to clear the event logs.  
    ![d3](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/b7e0696f-924a-43da-aeb8-2e1966887547)  
- Executing shellcode through process injection.  
    We will use Sysmon's capability to detect CreateRemoteThread and hunt for potential process injection. Sysmon's Event ID `8` (CreateRemoteThread), which detects when a process creates a thread in another process.  
    ```
    host.name: WKSTN-* AND winlog.event_id: 8
    ```  
    ![77c](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/411d6d22-8f11-4f97-bdb5-239b0bd01fb9)  
    Based on the results, the entry of `C:\Users\clifford.miller\Downloads\chrome.exe` created a new thread on `explorer.exe`, which is a typical target process threat actors use for process injection techniques. In addition, most entries are executed by a SYSTEM account, except for the chrome.exe, which is being run by Clifford Miller's account. 

# Persistence
[Persistence Tactic (TA0003)](https://attack.mitre.org/tactics/TA0003/)  
- Modification of registry keys to hijack the typical system/program startup.
- Installation of malicious scripts or software that automatically starts.
- Creation of additional high-privileged backdoor accounts.  

|Persistence Technique|Examples|
|:----|:----|
|Modification of registry keys|Using `reg.exe` to modify registry keys related to system boot-up, such as Run or RunOnce keys.|
|Installation of auto-start scripts|Creation of scheduled tasks (via `schtasks.exe`) to regularly update and execute the implanted malware.|
|Creation of additional accounts|Using `net.exe` to create a new user and add it to the local administrators' group.|  

## Hunting Persistence
- Scheduled Task creation.  
    `winlogbeat-*`  
    If Windows Advanced Audit Policy is properly configured, we can use Event ID `4698` (Scheduled Task Creation). Else, we can use the following keywords for hunting commands related to scheduled tasks: `schtasks and Register-ScheduledTask (PowerShell)`  
    ```
    host.name: WKSTN-* AND (winlog.event_id: 4698 OR (*schtasks* OR *Register-ScheduledTask*))
    ```  
    ![f5](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/2e0c8531-2440-4f69-9ec3-c899f198e449)  
    
- Registry key modification.  
    `winlogbeat-*`  
    Given that the operating system commonly uses it, events generated by monitoring registry modifications are overwhelming and differentiating benign activity from malicious ones might be tedious.  
    ```
    host.name: WKSTN-* AND winlog.event_id: 13 AND winlog.channel: Microsoft-Windows-Sysmon/Operational
    ```  
    To ease the way of hunting, we can focus on known registry keys abused by threat actors to reduce the results:
    - Software\Microsoft\Windows\CurrentVersion\Explorer\Shell (User Shell Folders)
    - Software\Microsoft\Windows\CurrentVersion\Run (RunOnce)  
    ```
    host.name: WKSTN-* AND winlog.event_id: 13 AND winlog.channel: Microsoft-Windows-Sysmon/Operational AND registry.path: (*CurrentVersion\\Run* OR *CurrentVersion\\Explorer\\User* OR *CurrentVersion\\Explorer\\Shell*)
    ```  
    ![4a](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/264ee2f3-a3f0-46d6-b1ab-e2eaf5365f67)  
    An alternative way of hunting unusual registry modifications is through process filtering.   
    ```
    host.name: WKSTN-* AND winlog.event_id: 13 AND winlog.channel: Microsoft-Windows-Sysmon/Operational AND process.name: (reg.exe OR powershell.exe)
    ```  
    ![cb](https://github.com/nkn-ctrl/TryHackMe/assets/73976100/b0a048f9-c3a6-417c-b0c6-3b18e9b274ac)  
    
# Command and Control  
[Command and Control Tactic (TA0011)](https://attack.mitre.org/tactics/TA0011/)  
- Standard network protocols, such as DNS, ICMP, HTTP/s.  
- Known cloud-based services.  
- Encrypted custom HTTP/s server.  

|Command and Control Technique|Examples|
|:----|:------|
|Standard network protocols|Using the DNS protocol as a communication channel via its subdomain.|
|Known cloud-based services|Passing traffic through known web applications such as Google Drive, Telegram and Discord.|
|Encrypted custom HTTP/s server	|Using a self-hosted server with a well-groomed domain passing encrypted traffic.|





    
